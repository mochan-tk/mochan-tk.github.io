
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>タイトル</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://mochan-tk.github.io/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid=""></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="handson-line-bot-power-automate-template"
                  title="タイトル"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="はじめに" duration="5">
        <h2 is-upgraded>概要</h2>
<p>LINE Botを作りつつ、Messaging API(および周辺の技術)の基本的な使い方を学んでいただければと思います！</p>
<h2 is-upgraded>当日の持ち物</h2>
<ul>
<li>LINEがインストール済みのスマホ</li>
<li>ChromeがインストールされたPC（Chromeのバージョンは最新のものを使っていただければと！）</li>
</ul>
<h2 is-upgraded>事前準備</h2>
<ul>
<li>Azureアカウント作成</li>
<li><a href="https://github.com/rnakamuramartiny/HowToM365-PPFDevelopEnvironment" target="_blank">Microsoft 365 開発者プログラムの登録、Power Apps 開発者向けプランの取得</a></li>
<li>LINEアカウント作成(こちらのサイトでログインできるかどうかを確認ください)</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="LINE DevelopersでMessaging API チャネルを作成する" duration="10">
        <h2 is-upgraded>チャネルの作成スタート</h2>
<p><a href="https://developers.line.me/ja/services/messaging-api/" target="_blank">https://developers.line.me/ja/services/messaging-api/</a> にアクセス。<br>「今すぐはじめよう」のボタンを押して進めていきましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/389235956c37eff6.png"></p>
<p>「LINEアカウントでログイン」を押してください。</p>
<p class="image-container"><img style="width: 421.15px" src="img/d5d421a6b299e62b.png"></p>
<p>LINEのログインを求められるのでログインしてください。</p>
<p class="image-container"><img style="width: 461.50px" src="img/53764d1928b87a53.png"></p>
<h2 is-upgraded>チャネルの種類</h2>
<p>Messaging APIになっているか確認します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/df3af770985c3f97.png"></p>
<h2 is-upgraded>プロバイダ</h2>
<p>既にプロバイダーを作っている場合 → 利用するプロバイダーを選択しましょう。</p>
<p><img style="width: 601.70px" src="img/d5302f954b527b82.png"><br>初めて → 新規プロバイダー作成を選択しプロバイダー名を入力しましょう。</p>
<p>（LINEという文字は含められません。）</p>
<p class="image-container"><img style="width: 601.70px" src="img/ed9832698ea66cc2.png"></p>
<h2 is-upgraded>会社・事業者の所在国・地域</h2>
<p class="image-container"><img style="width: 601.70px" src="img/57aa97698a2fec50.png"></p>
<h2 is-upgraded>チャネルアイコン</h2>
<p>チャネルアイコンを登録しましょう。（今回は必須ではありません）</p>
<p class="image-container"><img style="width: 601.70px" src="img/b25e887321903ca7.png"></p>
<h2 is-upgraded>チャネル名、チャネル説明</h2>
<p>下記を入力しましょう。</p>
<p>チャネル名：「HandsonBot」</p>
<p>チャネル説明：「HandsonBotです。」</p>
<p class="image-container"><img style="width: 601.70px" src="img/f4ec1d14f0d71421.png"></p>
<h2 is-upgraded>大業種、小業種</h2>
<p class="image-container"><img style="width: 601.70px" src="img/ed9b424f40f943e3.png"></p>
<h2 is-upgraded>メールアドレス、プライバシーポリシーURL、サービス利用規約URL</h2>
<p>メールアドレスを確認しましょう。</p>
<p>プライバシーポリシーURLとサービス利用規約URLは入力しなくても大丈夫です。</p>
<p class="image-container"><img style="width: 601.70px" src="img/4912ddf28b5920c5.png"></p>
<h2 is-upgraded>作成ボタン</h2>
<p>下記２点の利用規約にチェックをして「作成」ボタンを押しましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/1b112e894430dc9f.png"></p>
<p>「OK」を押しましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/6151acd3510ea8dd.png"></p>
<p>「同意する」を押しましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/e87adc9a93775ef.png"></p>
<h2 is-upgraded>LINE公式アカウント(LINE Bot)と友だちになる</h2>
<p>QRコードで友だち追加</p>
<p>「Messaging API設定」タブに移動し、QRコードを読み取って、友だち追加をしましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/1868e4298aafce8.png"></p>
<h2 is-upgraded>アクセストークンの取得</h2>
<p>アクセストークンをメモします。_φ(･_･</p>
<p class="image-container"><img style="width: 601.70px" src="img/3ea1abd939970269.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/69e0eb2664c9a94b.png"></p>
<aside class="special"><p><strong>Note:</strong></p>
<p>・ アクセストークン：LINEのAPI(機能)を実行する際に、認可が通り利用権限があることを証明するトークン</p>
</aside>
<h2 is-upgraded>応答モードをOFFにする</h2>
<p>応答メッセージの「編集」をクリックして、Botの「応答モード」設定をOFFにします。（デフォルトの設定はONになっており、メッセージを送るたびにデフォルトのメッセージが返ってきてしまうため）</p>
<p class="image-container"><img style="width: 601.70px" src="img/e5483b923824e085.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/7041ff8828881bb9.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Power Automateでフロー作成してオウム返しBotの開発" duration="0">
        <h2 is-upgraded>サインイン</h2>
<p><a href="https://powerautomate.microsoft.com/" target="_blank">https://powerautomate.microsoft.com/</a> にアクセス。</p>
<p>「サインイン」のボタンを押して進めていきましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/1d9848d670a95c26.png"></p>
<p>サインインをしましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/a82d57bc555be1ec.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/a3d4591ae9ba177a.png"></p>
<p>本人確認を行いましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/cff88b83261736aa.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/b3e8e157fb73cda2.png"></p>
<h2 is-upgraded>おうむ返しを作成</h2>
<p>作成の「インスタントクラウドフロー」をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/b5575a4972ed02d6.png"></p>
<p>フロー名を入力、HTTP要求の受信時を選択し、「作成」をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/20978b5362b7478.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/f8d4aecd43334847.png"></p>
<p>下記をコピーして、JSONスキーマに入力します。</p>
<pre><code>{
    &#34;properties&#34;: {
        &#34;events&#34;: {
            &#34;items&#34;: {
                &#34;properties&#34;: {
                    &#34;source&#34;: {
                        &#34;type&#34;: &#34;object&#34;,
                        &#34;properties&#34;: {
                            &#34;userId&#34;: {
                                &#34;type&#34;: &#34;string&#34;
                            }
                        }
                    },
                    &#34;message&#34;: {
                        &#34;properties&#34;: {
                            &#34;id&#34;: {
                                &#34;type&#34;: &#34;string&#34;
                            },
                            &#34;text&#34;: {
                                &#34;type&#34;: &#34;string&#34;
                            },
                            &#34;address&#34;: {
                                &#34;type&#34;: &#34;string&#34;
                            },
                            &#34;latitude&#34;: {
                                &#34;type&#34;: &#34;string&#34;
                            },
                            &#34;longitude&#34;: {
                                &#34;type&#34;: &#34;string&#34;
                            },
                            &#34;type&#34;: {
                                &#34;type&#34;: &#34;string&#34;
                            }
                        },
                        &#34;type&#34;: &#34;object&#34;
                    },
                    &#34;postback&#34;: {
                        &#34;properties&#34;: {
                            &#34;data&#34;: {
                                &#34;type&#34;: &#34;string&#34;
                            }
                        },
                        &#34;type&#34;: &#34;object&#34;
                    },
                    &#34;replyToken&#34;: {
                        &#34;type&#34;: &#34;string&#34;
                    },
                    &#34;type&#34;: {
                        &#34;type&#34;: &#34;string&#34;
                    }
                },
                &#34;required&#34;: [
                    &#34;replyToken&#34;,
                    &#34;type&#34;
                ],
                &#34;type&#34;: &#34;object&#34;
            },
            &#34;type&#34;: &#34;array&#34;
        }
    },
    &#34;type&#34;: &#34;object&#34;
}
</code></pre>
<p class="image-container"><img style="width: 601.70px" src="img/e0140831a2dff5d1.png"></p>
<p>「新しいステップ」をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/ca9fc937fee751b5.png"></p>
<p>「変数を初期化する」と検索し、変数を初期化するをクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/7db3a498d6af7d5a.png"></p>
<p>下記のように設定し、新しいステップを入力します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/b5d66c832a6fd53b.png"></p>
<p>同じように、「変数を初期化する」と検索し、変数を初期化するをクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/7db3a498d6af7d5a.png"></p>
<p>下記のように設定し、新しいステップをクリックします。</p>
<p>名前：access token</p>
<p>値：{LINE側でメモしたアクセストークン}</p>
<p class="image-container"><img style="width: 601.70px" src="img/4823bef5b4d2ea4d.png"></p>
<p>「コントロール」と検索し、「Apply to each」をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/339d7d937a9e2daa.png"></p>
<p>以前の手順から出力を選択に「@{triggerBody()?[&#39;events&#39;]}」を入力し、アクションを追加します。</p>
<p>「変数の設定」と検索し、「変数の設定」をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/d7a90d96f273313d.png"></p>
<p>下記のように設定します。</p>
<p>名前：msg</p>
<p>値：</p>
<pre><code>{
  &#34;replyToken&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;replyToken&#39;]}&#34;,
  &#34;messages&#34;: [
    {
      &#34;text&#34;: &#34;@{replace(replace(triggerBody()?[&#39;events&#39;][0][&#39;message&#39;][&#39;text&#39;],decodeUriComponent(&#39;%0D&#39;),&#39;\n&#39;),decodeUriComponent(&#39;%0A&#39;),&#39;\n&#39;)}&#34;,
      &#34;type&#34;: &#34;text&#34;
    }
  ]
}
</code></pre>
<p class="image-container"><img style="width: 601.70px" src="img/e9b99832807e9584.png"></p>
<aside class="special"><p><strong>Note:</strong></p>
<p>下記のjsonスキーマの公式ドキュメント参考</p>
<p>https://developers.line.biz/ja/reference/messaging-api/#send-reply-message</p>
</aside>
<p>一番下にある「新しいステップ」をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/ad756c1bd7f03191.png"></p>
<p>「条件」と検索し、条件をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/618f192d4a2fe070.png"></p>
<p>以下を設定します。</p>
<p>左側の値の選択に動的コンテンツから「msg」</p>
<p>真ん中は「次の値に等しくない」</p>
<p>右側の値の選択は何も入力しません。</p>
<p>「はい」の方にアクションの追加をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/ce307bc592a4c9bd.png"></p>
<p>HTTPと検索し、「HTTP」を選択します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/f648f2055963f971.png"></p>
<p>下記のように設定します。</p>
<p>・方法 → POST</p>
<p>・URI → https://api.line.me/v2/bot/message/reply</p>
<p>・ヘッダー → Content-Type ： application/json</p>
<p>                 Authorization ： Bearer {動的コンテンツから「access token」}</p>
<p>・本文 → 動的コンテンツから「msg」</p>
<p class="image-container"><img style="width: 601.70px" src="img/a8316d850bceb1eb.png"></p>
<p>上部にある保存ボタンをクリックします。</p>
<p>「HTTP要求の受信時」にあるURLをコピーします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/24ccf54f4cc7bd9c.png"></p>
<p>LINE側のMessaging APIのWebhook URLに保存し、Webhookの利用をオンにします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/23bc8dbec712031e.png"></p>
<p>ここでおうむ返しの動作確認ができます。</p>


      </google-codelab-step>
    
      <google-codelab-step label="リッチメニューを使う" duration="10">
        <h2 is-upgraded>LINE Official Account Manager 画面でリッチメニューの設定</h2>
<p>LINE公式アカウントの管理画面にアクセスし、<a href="https://www.linebiz.com/jp/column/technique/20180731-01/" target="_blank">リッチメニュー</a>を作成していきます。まずは「ホーム」→「リッチメニュー」→「作成」をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/280641be46ea1364.png"></p>
<p>「基本設定」の項目を入力し、その後テンプレートの選択を行います。</p>
<p class="image-container"><img style="width: 601.70px" src="img/9f23698d2d13e200.png"></p>
<p>ここでは４つのフレームに別れたテンプレートを選択します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/7183d8a321ec26af.png"></p>
<p>次にリッチメニューに使用する画像を作成します。「画像を作成」ボタンから、４つのフレームに対してそれぞれテキストを入力し、最後に右上の適用ボタンを押してください。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>場所</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>入力するテキスト</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>左上</p>
</td><td colspan="1" rowspan="1"><p>camera</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>右上</p>
</td><td colspan="1" rowspan="1"><p>位置情報</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>左下</p>
</td><td colspan="1" rowspan="1"><p>Flex</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>右下</p>
</td><td colspan="1" rowspan="1"><p>Quick Reply</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/9f2c970e2fabcaa4.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/c535c967fd01cc2f.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/9fd0f3233b892d4f.png"></p>
<p>次にアクションの項目を下記の情報を参考に埋めていきます。最後に保存ボタンを押すのをお忘れなく。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>番号</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>タイプ</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>入力欄</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>ラベル</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>A</p>
</td><td colspan="1" rowspan="1"><p>リンク</p>
</td><td colspan="1" rowspan="1"><p>https://line.me/R/nv/camera/</p>
</td><td colspan="1" rowspan="1"><p>camera</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>B</p>
</td><td colspan="1" rowspan="1"><p>リンク</p>
</td><td colspan="1" rowspan="1"><p>https://line.me/R/nv/location/</p>
</td><td colspan="1" rowspan="1"><p>location</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>C</p>
</td><td colspan="1" rowspan="1"><p>テキスト</p>
</td><td colspan="1" rowspan="1"><p>flex</p>
</td><td colspan="1" rowspan="1"><p>なし</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>D</p>
</td><td colspan="1" rowspan="1"><p>テキスト</p>
</td><td colspan="1" rowspan="1"><p>quick</p>
</td><td colspan="1" rowspan="1"><p>なし</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/575bb3c9f37956c3.png"></p>
<p>LINE公式アカウント(LINE Bot)上は下記のようになります。</p>
<p class="image-container"><img style="width: 455.77px" src="img/422d6d7d52fa4927.png"></p>
<aside class="special"><p><strong>Note:</strong> リッチメニューを使うと、このLINE公式アカウント(LINE Bot)がどんな機能を備えているかが視覚的にわかります。</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="（応用編）リッチメニューを使う" duration="10">
        <h2 is-upgraded>フローのインポート</h2>
<p>下記のGithubからZipファイルをダウンロードします。</p>
<p><a href="https://github.com/mochan-tk/Handson-LINE-Bot-Power-Automate-Richmenu-Importfile" target="_blank">https://github.com/mochan-tk/Handson-LINE-Bot-Power-Automate-Richmenu-Importfile</a></p>
<p class="image-container"><img style="width: 601.70px" src="img/ae3333c64b8ca7ea.png"></p>
<p>ダウンロードしたzipを解凍します。</p>
<p>下記にアクセスし、OneDriveにサインインします。</p>
<p><a href="https://onedrive.live.com/about/ja-jp/signin/" target="_blank">https://onedrive.live.com/about/ja-jp/signin/</a></p>
<p>「richmenu」フォルダを作成し、ダウンロードした「tabA.png」、「tabB.png」ファイルをアップロードします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/762e914224c03430.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/9832fdef8d29b321.png"></p>
<p>次にパッケージのインポートを行います。</p>
<p class="image-container"><img style="width: 601.70px" src="img/46399218c4a9506c.png"></p>
<p>インポートするパッケージを選択します。</p>
<h2 is-upgraded><img style="width: 601.70px" src="img/b5b927628f6688d3.png"></h2>
<p>関連リソースを作成します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/f91715e80a172e25.png"></p>
<p>新しい接続をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/c587edf1a11f23e1.png"></p>
<p>「OneDrive」を選択し、作成します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/a2d7fbb7c1ce9244.png"></p>
<p>サインインをしましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/a82d57bc555be1ec.png"></p>
<p>前の画面にもどり、「一覧の更新」を行い、作成したリソースを選び「保存」します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/5b4c1e3380be6943.png"></p>
<p>インポートします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/9175503391f01b04.png"></p>
<p>フローを「オン」にします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/55f1c4065a4d9f99.png"></p>
<p>「編集」画面へ移動し、アクセストークンを変更します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/50663168fe047695.png"></p>
<p>画面上部で「保存」をし、前の画面に戻り「実行」します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/536f2c48327e1074.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/2df849200f534a0e.png"></p>
<p>処理の確認をする際は実行履歴から確認できます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/6d0626e75e16f631.png"></p>
<p>リッチメニューのエラーは下記を確認してください。</p>
<p><a href="https://developers.line.biz/ja/reference/messaging-api/#create-rich-menu-alias-error-response" target="_blank">https://developers.line.biz/ja/reference/messaging-api/#create-rich-menu-alias-error-response</a></p>
<p>トーク画面から一旦離れ、確認します。</p>
<p class="image-container"><img style="width: 290.94px" src="img/961950f8deaa4f81.png"><img style="width: 290.50px" src="img/28e11dc96011afe3.png"></p>
<h2 is-upgraded>[補足]エクスポートの方法</h2>
<p>エクスポートしたフローを選択し、パッケージでエクスポートをします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/a39511b020094cc6.png"></p>
<p>任意に名前をつけて、インポートの設定を選択し、保存します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/7e2b1e8cb6ef91a9.png"></p>
<p>エクスポートします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/95e4cbb27235ac96.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="URLスキームを使う" duration="5">
        <p>URLスキームを使うとカメラや位置情報などが起動できたりします、いくつか用意されていますので試していきましょう。</p>
<ul>
<li><a href="https://developers.line.biz/ja/docs/messaging-api/using-line-url-scheme/" target="_blank">https://developers.line.biz/ja/docs/messaging-api/using-line-url-scheme/</a></li>
</ul>
<h2 is-upgraded>カメラの起動</h2>
<p>リッチメニュー左上の「camera」をタップしてください。カメラが起動します。</p>
<p class="image-container"><img style="width: 305.00px" src="img/f13286f87be6ecd9.gif"></p>
<h2 is-upgraded>位置情報の起動</h2>
<p>リッチメニュー右上の「位置情報」をタップしてください。位置情報が起動します。</p>
<p class="image-container"><img style="width: 305.00px" src="img/c77d3984c67a9dc4.gif"></p>


      </google-codelab-step>
    
      <google-codelab-step label="様々なメッセージ形式を扱う" duration="10">
        <p>LINEでは様々なメッセージ形式を扱うことができます。</p>
<ul>
<li><a href="https://developers.line.biz/ja/docs/messaging-api/message-types/" target="_blank">https://developers.line.biz/ja/docs/messaging-api/message-types/</a></li>
</ul>
<h2 is-upgraded>Flex Messageを扱う</h2>
<p>マイフローから、おうむ返しのフローに戻り、「Apply_to_each」の中にあるアクション追加をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/30d614d08b0a86cb.png"></p>
<p>「スイッチ」と検索し、スイッチをクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/b6316bd11dec4a30.png"></p>
<p>スイッチのオンに、「@{items(&#39;Apply_to_each&#39;)?[&#39;message&#39;][&#39;text&#39;]}」を入力します。</p>
<p>ケースに「flex」を入力し、規定の中に「変数の設定」をドラックアンドドロップします。</p>
<p>この例では、「flex」と入力したら、「flex」のケース側へ、それ以外は「規定」側へと処理します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/851e88402f8fe4b2.png"></p>
<p>「flex」にアクションを追加し、「変数の設定」と検索し、「変数の設定」をクリックします。</p>
<p class="image-container"><img style="width: 489.00px" src="img/febe0813021a6145.png"></p>
<p>下記のように設定し、保存します。</p>
<p>名前：msg</p>
<p>値：</p>
<pre><code>{
  &#34;replyToken&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;replyToken&#39;]}&#34;,
  &#34;messages&#34;: [
    {
      &#34;type&#34;: &#34;flex&#34;,
      &#34;altText&#34;: &#34;item list&#34;,
      &#34;contents&#34;: {
        &#34;type&#34;: &#34;carousel&#34;,
        &#34;contents&#34;: [
          {
            &#34;type&#34;: &#34;bubble&#34;,
            &#34;hero&#34;: {
              &#34;type&#34;: &#34;image&#34;,
              &#34;size&#34;: &#34;full&#34;,
              &#34;aspectRatio&#34;: &#34;20:13&#34;,
              &#34;aspectMode&#34;: &#34;cover&#34;,
              &#34;url&#34;: &#34;https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_5_carousel.png&#34;
            },
            &#34;body&#34;: {
              &#34;type&#34;: &#34;box&#34;,
              &#34;layout&#34;: &#34;vertical&#34;,
              &#34;spacing&#34;: &#34;sm&#34;,
              &#34;contents&#34;: [
                {
                  &#34;type&#34;: &#34;text&#34;,
                  &#34;text&#34;: &#34;Arm Chair, White&#34;,
                  &#34;wrap&#34;: true,
                  &#34;weight&#34;: &#34;bold&#34;,
                  &#34;size&#34;: &#34;xl&#34;
                },
                {
                  &#34;type&#34;: &#34;box&#34;,
                  &#34;layout&#34;: &#34;baseline&#34;,
                  &#34;contents&#34;: [
                    {
                      &#34;type&#34;: &#34;text&#34;,
                      &#34;text&#34;: &#34;$49&#34;,
                      &#34;wrap&#34;: true,
                      &#34;weight&#34;: &#34;bold&#34;,
                      &#34;size&#34;: &#34;xl&#34;,
                      &#34;flex&#34;: 0
                    },
                    {
                      &#34;type&#34;: &#34;text&#34;,
                      &#34;text&#34;: &#34;.99&#34;,
                      &#34;wrap&#34;: true,
                      &#34;weight&#34;: &#34;bold&#34;,
                      &#34;size&#34;: &#34;sm&#34;,
                      &#34;flex&#34;: 0
                    }
                  ]
                }
              ]
            },
            &#34;footer&#34;: {
              &#34;type&#34;: &#34;box&#34;,
              &#34;layout&#34;: &#34;vertical&#34;,
              &#34;spacing&#34;: &#34;sm&#34;,
              &#34;contents&#34;: [
                {
                  &#34;type&#34;: &#34;button&#34;,
                  &#34;style&#34;: &#34;primary&#34;,
                  &#34;action&#34;: {
                    &#34;type&#34;: &#34;uri&#34;,
                    &#34;label&#34;: &#34;Add to Cart&#34;,
                    &#34;uri&#34;: &#34;https://linecorp.com&#34;
                  }
                },
                {
                  &#34;type&#34;: &#34;button&#34;,
                  &#34;action&#34;: {
                    &#34;type&#34;: &#34;uri&#34;,
                    &#34;label&#34;: &#34;Add to wishlist&#34;,
                    &#34;uri&#34;: &#34;https://linecorp.com&#34;
                  }
                }
              ]
            }
          },
          {
            &#34;type&#34;: &#34;bubble&#34;,
            &#34;hero&#34;: {
              &#34;type&#34;: &#34;image&#34;,
              &#34;size&#34;: &#34;full&#34;,
              &#34;aspectRatio&#34;: &#34;20:13&#34;,
              &#34;aspectMode&#34;: &#34;cover&#34;,
              &#34;url&#34;: &#34;https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_6_carousel.png&#34;
            },
            &#34;body&#34;: {
              &#34;type&#34;: &#34;box&#34;,
              &#34;layout&#34;: &#34;vertical&#34;,
              &#34;spacing&#34;: &#34;sm&#34;,
              &#34;contents&#34;: [
                {
                  &#34;type&#34;: &#34;text&#34;,
                  &#34;text&#34;: &#34;Metal Desk Lamp&#34;,
                  &#34;wrap&#34;: true,
                  &#34;weight&#34;: &#34;bold&#34;,
                  &#34;size&#34;: &#34;xl&#34;
                },
                {
                  &#34;type&#34;: &#34;box&#34;,
                  &#34;layout&#34;: &#34;baseline&#34;,
                  &#34;flex&#34;: 1,
                  &#34;contents&#34;: [
                    {
                      &#34;type&#34;: &#34;text&#34;,
                      &#34;text&#34;: &#34;$11&#34;,
                      &#34;wrap&#34;: true,
                      &#34;weight&#34;: &#34;bold&#34;,
                      &#34;size&#34;: &#34;xl&#34;,
                      &#34;flex&#34;: 0
                    },
                    {
                      &#34;type&#34;: &#34;text&#34;,
                      &#34;text&#34;: &#34;.99&#34;,
                      &#34;wrap&#34;: true,
                      &#34;weight&#34;: &#34;bold&#34;,
                      &#34;size&#34;: &#34;sm&#34;,
                      &#34;flex&#34;: 0
                    }
                  ]
                },
                {
                  &#34;type&#34;: &#34;text&#34;,
                  &#34;text&#34;: &#34;Temporarily out of stock&#34;,
                  &#34;wrap&#34;: true,
                  &#34;size&#34;: &#34;xxs&#34;,
                  &#34;margin&#34;: &#34;md&#34;,
                  &#34;color&#34;: &#34;#ff5551&#34;,
                  &#34;flex&#34;: 0
                }
              ]
            },
            &#34;footer&#34;: {
              &#34;type&#34;: &#34;box&#34;,
              &#34;layout&#34;: &#34;vertical&#34;,
              &#34;spacing&#34;: &#34;sm&#34;,
              &#34;contents&#34;: [
                {
                  &#34;type&#34;: &#34;button&#34;,
                  &#34;flex&#34;: 2,
                  &#34;style&#34;: &#34;primary&#34;,
                  &#34;color&#34;: &#34;#aaaaaa&#34;,
                  &#34;action&#34;: {
                    &#34;type&#34;: &#34;uri&#34;,
                    &#34;label&#34;: &#34;Add to Cart&#34;,
                    &#34;uri&#34;: &#34;https://linecorp.com&#34;
                  }
                },
                {
                  &#34;type&#34;: &#34;button&#34;,
                  &#34;action&#34;: {
                    &#34;type&#34;: &#34;uri&#34;,
                    &#34;label&#34;: &#34;Add to wish list&#34;,
                    &#34;uri&#34;: &#34;https://linecorp.com&#34;
                  }
                }
              ]
            }
          },
          {
            &#34;type&#34;: &#34;bubble&#34;,
            &#34;body&#34;: {
              &#34;type&#34;: &#34;box&#34;,
              &#34;layout&#34;: &#34;vertical&#34;,
              &#34;spacing&#34;: &#34;sm&#34;,
              &#34;contents&#34;: [
                {
                  &#34;type&#34;: &#34;button&#34;,
                  &#34;flex&#34;: 1,
                  &#34;gravity&#34;: &#34;center&#34;,
                  &#34;action&#34;: {
                    &#34;type&#34;: &#34;uri&#34;,
                    &#34;label&#34;: &#34;See more&#34;,
                    &#34;uri&#34;: &#34;https://linecorp.com&#34;
                  }
                }
              ]
            }
          }
        ]
      }
    }
  ]
}
</code></pre>
<p class="image-container"><img style="width: 601.70px" src="img/3aae82117b6d6cf2.png"></p>
<p>リッチメニューの左下をタップして、「flex」というテキストメッセージを投稿します。するとちょっとリッチなUIが返ってくると思います。これがFlex Messageです。<a href="https://developers.line.biz/flex-simulator/" target="_blank">Flex Message Simulator</a> が用意されており、レイアウトを簡単にカスタマイズすることができます。（詳細は<a href="https://developers.line.biz/ja/docs/messaging-api/using-flex-message-simulator/" target="_blank">コチラ</a>を参照ください。）</p>
<p class="image-container"><img style="width: 305.00px" src="img/81d3c8209c747f44.gif"></p>
<h2 is-upgraded>Quick Replyを扱う</h2>
<p>flexの隣にケース２を追加し、「quick」と入力する。</p>
<p>flexと同じように「変数の設定」アクションを追加し、下記を設定します。</p>
<pre><code>{
  &#34;replyToken&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;replyToken&#39;]}&#34;,
  &#34;messages&#34;: [
    {
      &#34;text&#34;: &#34;ステッカー欲しいですか❓YesかNoで答えてください, もしくは素敵な写真送って❗️&#34;,
      &#34;quickReply&#34;: {
        &#34;items&#34;: [
          {
            &#34;type&#34;: &#34;action&#34;,
            &#34;action&#34;: {
              &#34;type&#34;: &#34;postback&#34;,
              &#34;label&#34;: &#34;Yes&#34;,
              &#34;data&#34;: &#34;sticker&#34;,
              &#34;displayText&#34;: &#34;ステッカーください❗️&#34;
            }
          },
          {
            &#34;type&#34;: &#34;action&#34;,
            &#34;action&#34;: {
              &#34;type&#34;: &#34;message&#34;,
              &#34;label&#34;: &#34;No&#34;,
              &#34;text&#34;: &#34;不要。&#34;
            }
          },
          {
            &#34;type&#34;: &#34;action&#34;,
            &#34;action&#34;: {
              &#34;type&#34;: &#34;camera&#34;,
              &#34;label&#34;: &#34;camera&#34;
            }
          }
        ]
      },
      &#34;type&#34;: &#34;text&#34;
    }
  ]
}
</code></pre>
<p class="image-container"><img style="width: 601.70px" src="img/2405ef6194e5fed5.png"></p>
<p>「Apply_to_each」の下部にあるアクションの追加をクリックし、スイッチアクションを追加します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/cbcc354bf20b2f5e.png"></p>
<p>オンに「@{items(&#39;Apply_to_each&#39;)?[&#39;type&#39;]}」、ケースに「message」、ケース２に「postback」を入力します。</p>
<p>message側にflexやquickの設定をした「スイッチ」をドラックアンドドロップで移動します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/7f6b8c906262b8a7.png"></p>
<p>ケース２「postback」に、「スイッチ」アクションを追加する。</p>
<p>「スイッチ」のオンに「@{items(&#39;Apply_to_each&#39;)?[&#39;postback&#39;]?[&#39;data&#39;]}」、ケースに「sticker」を入力し、「変数の設定」アクションを追加し、下記を設定します。</p>
<p>保存します。</p>
<pre><code>{
  &#34;replyToken&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;replyToken&#39;]}&#34;,
  &#34;messages&#34;: [
    {
      &#34;type&#34;: &#34;sticker&#34;,
      &#34;packageId&#34;: &#34;11537&#34;,
      &#34;stickerId&#34;: &#34;52002735&#34;
    }
  ]
}</code></pre>
<p class="image-container"><img style="width: 601.70px" src="img/c5dccca5322e5393.png"></p>
<p>クイックリプライを使うとユーザは簡単に返信を行うことができます。</p>
<p class="image-container"><img style="width: 305.00px" src="img/c9c578aa154790e8.gif"></p>
<aside class="special"><p><strong>Note:</strong> 今回クイックリプライには「Yes」、「No」、「camera」の選択肢を用意しました。「Yes」とするとpostbackというメッセージの送信を行うようにしています。</p>
<p>詳しくは下記を参照ください。</p>
<p>https://developers.line.biz/ja/docs/messaging-api/actions/#postback-action</p>
</aside>
<h2 is-upgraded>位置情報メッセージを扱う</h2>
<p>ケース「message」側で「スイッチ」アクションを追加します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/857626ada2198c2c.png"></p>
<p>オンに「@{items(&#39;Apply_to_each&#39;)?[&#39;message&#39;]?[&#39;type&#39;]}」ケースに「text」、隣にケース２「location」を入力します。</p>
<p>text側にflexやquickの設定をした「スイッチ」をドラッグアンドドロップで移動します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/233783bdc0f6b174.png"></p>
<p>location側に変数の設定アクションを追加し、下記を設定します。</p>
<p>保存します。</p>
<pre><code>{
  &#34;replyToken&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;replyToken&#39;]}&#34;,
  &#34;messages&#34;: [
    {
      &#34;type&#34;: &#34;location&#34;,
      &#34;title&#34;: &#34;現在地&#34;,
      &#34;address&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;message&#39;]?[&#39;address&#39;]}&#34;,
      &#34;latitude&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;message&#39;]?[&#39;latitude&#39;]}&#34;,
      &#34;longitude&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;message&#39;]?[&#39;longitude&#39;]}&#34;
    }
  ]
}</code></pre>
<p class="image-container"><img style="width: 601.70px" src="img/d31919253a5865a3.png"></p>
<p>位置情報をトーク画面に投稿してみてください。全く同じ位置情報メッセージが返ってくると思います。</p>
<p class="image-container"><img style="width: 314.70px" src="img/296c40c60046721f.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="（応用編）画像メッセージを扱う" duration="0">
        <aside class="warning"><p><strong>注意:</strong> ここから先の手順はMicrosoft Azureのアカウントが必要になります。</p>
</aside>
<p>ケース２「location」のとなりに、ケース３「image」を追加します。</p>
<p>そこに、HTTPアクションを追加し、送った画像のコンテンツを取得します。</p>
<p>下記のように設定し保存します。</p>
<p>・方法 → GET</p>
<p>・URI → https://api-data.line.me/v2/bot/message/@{items(&#39;Apply_to_each&#39;)?[&#39;message&#39;]?[&#39;id&#39;]}/content</p>
<p>・ヘッダー → Authorization ： Bearer 動的コンテンツの「access token」</p>
<aside class="special"><p><strong>Note:</strong> LINE公式ドキュメントを参考</p>
<p>https://developers.line.biz/ja/reference/messaging-api/#get-content</p>
</aside>
<p class="image-container"><img style="width: 601.70px" src="img/2ef7e0133165d17f.png"></p>
<p>Azureアカウントに接続し、ストレージアカウントを作成します。</p>
<p><a href="https://portal.azure.com/#create/Microsoft.StorageAccount-ARM" target="_blank">https://portal.azure.com/#create/Microsoft.StorageAccount-ARM</a></p>
<p class="image-container"><img style="width: 601.70px" src="img/8ad1ff242422c03a.png"></p>
<p><img style="width: 601.70px" src="img/1b07234cc68390d2.png">「images」でコンテナを作成します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/d2319d9d7ae4ec2c.png"></p>
<p>送った画像を保存するために下記のロールを追加します。</p>
<p>・ストレージ BLOB データ共同作成者</p>
<p class="image-container"><img style="width: 601.70px" src="img/cf1560c84e4ead91.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/91bf600ea8b39fd4.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/11437e71a731a26c.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/b684f481bc86d803.png"></p>
<p>Power Automate画面に戻り、「HTTP」アクションの下に「BLOB を作成する(V2)」アクションを追加します。</p>
<p>サインインをします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/736ab61f5a18040e.png"><img style="width: 601.70px" src="img/705fc23fa3b3573a.png"></p>
<p>ストレージアカウント名は「カスタム値の入力」を選択してから、Azureで作成したアカウント名を入力します。</p>
<p>フォルダパスは右にあるフォルダマークを押して選択します。</p>
<p>・BLOB名：@{items(&#39;Apply_to_each&#39;)?[&#39;message&#39;]?[&#39;id&#39;]}</p>
<p>・BLOBコンテンツ：@{body(&#39;HTTP_2&#39;)}</p>
<p class="image-container"><img style="width: 601.70px" src="img/378bdc505c6c4a36.png"></p>
<p>「変数の設定」アクションを追加し、下記を入力します。</p>
<p>{ストレージアカウント名}に、Azureで作成したアカウント名に置き換えます。</p>
<p>保存します。</p>
<pre><code>{
  &#34;replyToken&#34;: &#34;@{items(&#39;Apply_to_each&#39;)?[&#39;replyToken&#39;]}&#34;,
  &#34;messages&#34;: [
    {
      &#34;type&#34;: &#34;image&#34;,
      &#34;originalContentUrl&#34;: &#34;https://{ストレージアカウント名}.blob.core.windows.net@{outputs(&#39;BLOB_を作成する_(V2)&#39;)?[&#39;body/Path&#39;]}&#34;,
      &#34;previewImageUrl&#34;: &#34;https://{ストレージアカウント名}.blob.core.windows.net@{outputs(&#39;BLOB_を作成する_(V2)&#39;)?[&#39;body/Path&#39;]}&#34;
    }
  ]
}</code></pre>
<p class="image-container"><img style="width: 601.70px" src="img/480aa704a1cf578c.png"></p>
<p>カメラを起動して写真を撮るか既に撮った写真を選択するかで、画像をトーク画面に投稿してみてください。送った画像をそのまま返すコードを今回用意しました。</p>
<p class="image-container"><img style="width: 314.16px" src="img/e702d58f7892288f.png"></p>
<aside class="special"><p><strong>Note:</strong> 投稿した画像をそのまま返すにあたり、コードでは [投稿された画像をAzure Storageに格納] &gt; [Azure Storageに格納された画像のURLを取得] &gt; [画像メッセージとしてユーザに返す] という流れで実施しています。</p>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://mochan-tk.github.io/codelab-elements/native-shim.js"></script>
  <script src="https://mochan-tk.github.io/codelab-elements/custom-elements.min.js"></script>
  <script src="https://mochan-tk.github.io/codelab-elements/prettify.js"></script>
  <script src="https://mochan-tk.github.io/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
