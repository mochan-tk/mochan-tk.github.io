
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>タイトル</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://mochan-tk.github.io/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid=""></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="handson-line-bot-azure-template"
                  title="タイトル"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="はじめに" duration="5">
        <h2 is-upgraded>概要</h2>
<p>LINE Botを作りつつ、Messaging API(および周辺の技術)の基本的な使い方を学んでいただければと思います！</p>
<h2 is-upgraded>当日の持ち物</h2>
<ul>
<li>LINEがインストール済みのスマホ</li>
<li>ChromeがインストールされたPC（Chromeのバージョンは最新のものを使っていただければと！）</li>
</ul>
<h2 is-upgraded>事前準備</h2>
<ul>
<li><a href="https://github.com/join?source=header" target="_blank">GitHubアカウント</a>作成</li>
<li><a href="https://azure.microsoft.com/ja-jp/free/" target="_blank">Azureアカウント</a>作成</li>
<li>LINEアカウント作成(<a href="https://developers.line.me/console/" target="_blank">こちらのサイト</a>でログインできるかどうかを確認ください)</li>
</ul>
<h2 is-upgraded>使用するサービス・ツール</h2>
<ul>
<li>Microsoft Azure Functions, Storage, Cosmos DB, Bicep</li>
<li>Node.js</li>
<li>Gitpod(月50時間無料)</li>
<li>GitHub</li>
</ul>
<h2 is-upgraded>構成図</h2>
<p class="image-container"><img style="width: 601.70px" src="img/94ded6535d3dec68.png"></p>
<h2 is-upgraded>注意事項</h2>
<p>若干、Microsoft Azureの課金が発生する可能性があります。それ以外は課金など発生しません。</p>


      </google-codelab-step>
    
      <google-codelab-step label="LINE DevelopersでMessaging API チャネルを作成する" duration="10">
        <h2 is-upgraded>チャネルの作成スタート</h2>
<p><a href="https://developers.line.me/ja/services/messaging-api/" target="_blank">https://developers.line.me/ja/services/messaging-api/</a> にアクセス。<br>「今すぐはじめよう」のボタンを押して進めていきましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/389235956c37eff6.png"></p>
<p>「LINEアカウントでログイン」を押してください。</p>
<p class="image-container"><img style="width: 421.15px" src="img/d5d421a6b299e62b.png"></p>
<p>LINEのログインを求められるのでログインしてください。</p>
<p class="image-container"><img style="width: 461.50px" src="img/53764d1928b87a53.png"></p>
<h2 is-upgraded>チャネルの種類</h2>
<p>Messaging APIになっているか確認します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/df3af770985c3f97.png"></p>
<h2 is-upgraded>プロバイダ</h2>
<p>既にプロバイダーを作っている場合 → 利用するプロバイダーを選択しましょう。</p>
<p><img style="width: 601.70px" src="img/d5302f954b527b82.png"><br>初めて → 新規プロバイダー作成を選択しプロバイダー名を入力しましょう。</p>
<p>（LINEという文字は含められません。）</p>
<p class="image-container"><img style="width: 601.70px" src="img/ed9832698ea66cc2.png"></p>
<h2 is-upgraded>会社・事業者の所在国・地域</h2>
<p class="image-container"><img style="width: 601.70px" src="img/57aa97698a2fec50.png"></p>
<h2 is-upgraded>チャネルアイコン</h2>
<p>チャネルアイコンを登録しましょう。（今回は必須ではありません）</p>
<p class="image-container"><img style="width: 601.70px" src="img/b25e887321903ca7.png"></p>
<h2 is-upgraded>チャネル名、チャネル説明</h2>
<p>下記を入力しましょう。</p>
<p>チャネル名：「HandsonBot」</p>
<p>チャネル説明：「HandsonBotです。」</p>
<p class="image-container"><img style="width: 601.70px" src="img/f4ec1d14f0d71421.png"></p>
<h2 is-upgraded>大業種、小業種</h2>
<p class="image-container"><img style="width: 601.70px" src="img/ed9b424f40f943e3.png"></p>
<h2 is-upgraded>メールアドレス、プライバシーポリシーURL、サービス利用規約URL</h2>
<p>メールアドレスを確認しましょう。</p>
<p>プライバシーポリシーURLとサービス利用規約URLは入力しなくても大丈夫です。</p>
<p class="image-container"><img style="width: 601.70px" src="img/4912ddf28b5920c5.png"></p>
<h2 is-upgraded>作成ボタン</h2>
<p>下記２点の利用規約にチェックをして「作成」ボタンを押しましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/1b112e894430dc9f.png"></p>
<p>「OK」を押しましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/6151acd3510ea8dd.png"></p>
<p>「同意する」を押しましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/e87adc9a93775ef.png"></p>
<h2 is-upgraded>LINE公式アカウント(LINE Bot)と友だちになる</h2>
<p>QRコードで友だち追加</p>
<p>「Messaging API設定」タブに移動し、QRコードを読み取って、友だち追加をしましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/1868e4298aafce8.png"></p>
<h2 is-upgraded>チャネルシークレット、アクセストークンの取得</h2>
<p>「チャネル基本設定」タブからチャネルシークレットを、「Messaging API設定」タブからアクセスキーをそれぞれ取得します。</p>
<ul>
<li>チャネルシークレット</li>
</ul>
<p class="image-container"><img style="width: 601.70px" src="img/f3eb6548a6c5e0c6.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/aeece43ae5e06e73.png"></p>
<ul>
<li>アクセストークン</li>
</ul>
<p class="image-container"><img style="width: 601.70px" src="img/c0731f4e918e06da.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/3ea1abd939970269.png"></p>
<aside class="special"><p><strong>Note:</strong></p>
<p>・チャネルシークレット：Botサーバで受信したリクエストが不正なものでないかのチェックで使用される(LINE以外のサーバーからリクエストが送られていないかの確認)</p>
<p>・ アクセストークン：LINEのAPI(機能)を実行する際に、認可が通り利用権限があることを証明するトークン</p>
</aside>
<h2 is-upgraded>応答モードをOFFにする</h2>
<p>LINE Official Account Manager 画面にアクセスして、Botの「応答モード」設定をOFFにします。（デフォルトの設定はONになっており、メッセージを送るたびにデフォルトのメッセージが返ってきてしまうため）</p>
<p class="image-container"><img style="width: 601.70px" src="img/eaa773a4f9e436e6.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/24dfe305142dad62.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Webhookの設定作業" duration="15">
        <h2 is-upgraded>GitHubリポジトリのFork</h2>
<p><a href="https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template" target="_blank">https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template</a> にアクセス。</p>
<p>右上のForkボタンを押して自分のGitHubアカウントにリポジトリをコピーしてください。</p>
<p class="image-container"><img style="width: 601.70px" src="img/9bc2fa4c69031653.png"></p>
<h2 is-upgraded>Gitpod起動</h2>
<p>下記のいずれかの方法でGitpodを起動してください。</p>
<ul>
<li><a href="https://chrome.google.com/webstore/detail/gitpod-always-ready-to-co/dodmmooeoklaejobgleioelladacbeki" target="_blank">Chromeの拡張機能</a>を入れてGitHubリポジトリ上のGitpodボタンを押してGitpodを起動する</li>
</ul>
<p class="image-container"><img style="width: 586.50px" src="img/aa1966c691c5e015.png"></p>
<ul>
<li>GitpodのURLを先頭につけてGitpodを起動する</li>
</ul>
<p><a href="https://gitpod.io#https://github.com/" target="_blank">https://<strong>gitpod</strong>.io#https://github.com/</a><strong>&lt;ご自分のアカウント名&gt;</strong>/Handson-LINE-Bot-Azure-template</p>
<p class="image-container"><img style="width: 601.70px" src="img/678d95baff67048b.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/11a0b7c34ec2dcc8.png"></p>
<aside class="warning"><p><strong>注意:</strong> 起動には10分ほどかかります。</p>
</aside>
<h2 is-upgraded>Botサーバーの用意</h2>
<p>Gitpodのターミナル上で下記のコマンドを実行していってください。</p>
<p class="image-container"><img style="width: 601.70px" src="img/5762a325cb7451e.png"></p>
<ul>
<li>実行するコマンド</li>
</ul>
<pre><code>az upgrade

az bicep install

## 下記を実行し表示されたURLにアクセス、さらにコードも表示されているのでURL先に設定してログインを実施する
az login --use-device-code

## 下記を実行でAzureのサブスクリプションIDを取得
az account list \
  --refresh \
  --query &#34;[].id&#34; \
  --output table

## &lt;your subscription id&gt;の部分を、上記で取得したAzureのサブスクリプションIDに置き換える
az account set --subscription &lt;your subscription id&gt;

group_name=20220615LineBot

az group create --name ${group_name} --location japaneast

az configure --defaults group=${group_name}

## ココでramdomな値を取得 &gt; https://1password.com/jp/password-generator/
## secretとaccessはLINE Developersのチャネル設定でメモした値を入れる
az deployment group create --name deployPrj01 --template-file main.bicep \
 --parameters ramdom=&lt;ramdom&gt; \
 --parameters secret=&lt;secret&gt; \
 --parameters access=&lt;access&gt;
</code></pre>
<p>実行後のAzureリソースは下記のような構成。</p>
<p class="image-container"><img style="width: 601.70px" src="img/7c4052dd50f11e06.png"></p>
<aside class="special"><p><strong>Note: </strong>ここまでのコマンド実行で今回必要なAzureの構成が作成されます。構成はmain.bicepファイルで管理しています。</p>
<p>VS CodeにはBicepの拡張機能があるので、VS Codeを使うとBicepを使うのが非常に楽になります。</p>
</aside>
<h2 is-upgraded>アプリケーションコードのデプロイ</h2>
<p>Gitpodのターミナル上で下記のコマンドを実行していってください。ここまでの手順で作成されているAzure Functionsにアプリケーションのコードがデプロイされます。</p>
<ul>
<li>実行するコマンド</li>
</ul>
<pre><code>cd /workspace/Handson-LINE-Bot-Azure-template/deployPrj01/

## 下記実行で、作成したAzure Functionsの名前を取得
az deployment group show \
 -g ${group_name} \
 -n deployPrj01 \
 --query properties.outputs.functionAppName.value

## &lt;functionAppName&gt;の部分を、上記で取得したAzure Functionsの名前に置き換える
func azure functionapp publish &lt;functionAppName&gt; --build remote
</code></pre>
<p>上記、実行後は下記のようにURLが払い出されるのでメモしておきます。（Webhookの設定で使います）</p>
<p class="image-container"><img style="width: 601.70px" src="img/6aacfa13ee1662d1.png"></p>
<h2 is-upgraded>Webhookの設定</h2>
<p>LINE Developersのコンソール画面に戻って、「Messaging API設定」タブから上記で取得したAzure FunctionsのURLを設定します。これでLINEのBotを動かす準備は全て整いました！</p>
<p class="image-container"><img style="width: 601.70px" src="img/c0731f4e918e06da.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/4e58c63dac8d364f.png"></p>
<h2 is-upgraded>動作確認</h2>
<p>さっそく動かしてみましょう。トーク画面からBotに対してメッセージを送るとオウム返しでメッセージが送られてきたと思います！</p>
<p class="image-container"><img style="width: 601.70px" src="img/4fc05c2c8f632668.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="リッチメニューを使う" duration="10">
        <h2 is-upgraded>LINE Official Account Manager 画面でリッチメニューの設定</h2>
<p>LINE公式アカウントの管理画面にアクセスし、<a href="https://www.linebiz.com/jp/column/technique/20180731-01/" target="_blank">リッチメニュー</a>を作成していきます。まずは「表示設定」の項目を入力し、その後テンプレートの選択を行います。（ここでは４つのフレームに別れたテンプレートを選択します。）</p>
<p class="image-container"><img style="width: 601.70px" src="img/d2dd02d6f54c87bb.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/523878844c89a87f.png"></p>
<p>次にリッチメニューに使用する画像を作成します。「画像を作成」ボタンから、４つのフレームに対してそれぞれテキストを入力し、最後に右上の適用ボタンを押してください。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>場所</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>入力するテキスト</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>左上</p>
</td><td colspan="1" rowspan="1"><p>camera</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>右上</p>
</td><td colspan="1" rowspan="1"><p>位置情報</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>左下</p>
</td><td colspan="1" rowspan="1"><p>Flex</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>右下</p>
</td><td colspan="1" rowspan="1"><p>Quick Reply</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/a8cfc65442c1888b.png"></p>
<p>次にアクションの項目を下記の情報を参考に埋めていきます。最後に保存ボタンを押すのをお忘れなく。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>番号</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>タイプ</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>入力欄</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>ラベル</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>A</p>
</td><td colspan="1" rowspan="1"><p>リンク</p>
</td><td colspan="1" rowspan="1"><p>https://line.me/R/nv/camera/</p>
</td><td colspan="1" rowspan="1"><p>camera</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>B</p>
</td><td colspan="1" rowspan="1"><p>リンク</p>
</td><td colspan="1" rowspan="1"><p>https://line.me/R/nv/location/</p>
</td><td colspan="1" rowspan="1"><p>location</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>C</p>
</td><td colspan="1" rowspan="1"><p>テキスト</p>
</td><td colspan="1" rowspan="1"><p>flex</p>
</td><td colspan="1" rowspan="1"><p>なし</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>D</p>
</td><td colspan="1" rowspan="1"><p>テキスト</p>
</td><td colspan="1" rowspan="1"><p>quick</p>
</td><td colspan="1" rowspan="1"><p>なし</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/be1bbc3ce048717c.png"></p>
<p>LINE公式アカウント(LINE Bot)上は下記のようになります。</p>
<p class="image-container"><img style="width: 601.70px" src="img/48b9095ee7cd3893.png"></p>
<aside class="special"><p><strong>Note:</strong> リッチメニューを使うと、このLINE公式アカウント(LINE Bot)がどんな機能を備えているかが視覚的にわかります。</p>
</aside>
<h2 is-upgraded>（参考）Messaging APIでのリッチメニューを作成</h2>
<p>リッチメニューはMessaging APIでも作成でき、さらに柔軟な対応が可能です。今回のハンズオンの後半（『リッチメニュー応用』）で扱っていきます。</p>
<p>下記に参考情報も記載いたします。</p>
<ul>
<li><a href="https://developers.line.biz/ja/docs/messaging-api/using-rich-menus/#creating-a-rich-menu-using-the-messaging-api" target="_blank">Messaging APIでリッチメニューを作成する</a></li>
<li><a href="https://developers.line.biz/ja/docs/messaging-api/try-rich-menu/" target="_blank">リッチメニュープレイグラウンドでリッチメニューを試す</a></li>
<li><a href="http://youtube.com/watch?v=_sbzsK-3gYg" target="_blank">（YouTube）LIFFもいいけどリッチメニューを触ってみよう！ / 内西 功一 / LINE Developers Community REV UP 2021</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="URLスキームを使う" duration="5">
        <p>URLスキームを使うとカメラや位置情報などが起動できたりします、いくつか用意されていますので試していきましょう。</p>
<ul>
<li><a href="https://developers.line.biz/ja/docs/messaging-api/using-line-url-scheme/" target="_blank">https://developers.line.biz/ja/docs/messaging-api/using-line-url-scheme/</a></li>
</ul>
<h2 is-upgraded>カメラの起動</h2>
<p>リッチメニュー左上の「camera」をタップしてください。カメラが起動します。</p>
<p class="image-container"><img style="width: 305.00px" src="img/f13286f87be6ecd9.gif"></p>
<h2 is-upgraded>位置情報の起動</h2>
<p>リッチメニュー右上の「位置情報」をタップしてください。位置情報が起動します。</p>
<p class="image-container"><img style="width: 305.00px" src="img/c77d3984c67a9dc4.gif"></p>


      </google-codelab-step>
    
      <google-codelab-step label="様々なメッセージ形式を扱う" duration="10">
        <p>LINEでは様々なメッセージ形式を扱うことができます。</p>
<ul>
<li><a href="https://developers.line.biz/ja/docs/messaging-api/message-types/" target="_blank">https://developers.line.biz/ja/docs/messaging-api/message-types/</a></li>
</ul>
<p>今回のコードも見ていただくと理解がグッと進みます。</p>
<ul>
<li><a href="https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L60" target="_blank">https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L60</a></li>
</ul>
<h2 is-upgraded>画像メッセージを扱う</h2>
<p>カメラを起動して写真を撮るか既に撮った写真を選択するかで、画像をトーク画面に投稿してみてください。送った画像をそのまま返すコードを今回用意しました。</p>
<ul>
<li><a href="https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L119" target="_blank">https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L119</a></li>
</ul>
<p class="image-container"><img style="width: 314.16px" src="img/e702d58f7892288f.png"></p>
<aside class="special"><p><strong>Note:</strong> 投稿した画像をそのまま返すにあたり、コードでは [投稿された画像をAzure Storageに格納] &gt; [Azure Storageに格納された画像のURLを取得] &gt; [画像メッセージとしてユーザに返す] という流れで実施しています。</p>
</aside>
<h2 is-upgraded>位置情報メッセージを扱う</h2>
<p>位置情報をトーク画面に投稿してみてください。全く同じ位置情報メッセージが返ってくると思います。</p>
<ul>
<li><a href="https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L144" target="_blank">https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L144</a></li>
</ul>
<p class="image-container"><img style="width: 314.70px" src="img/296c40c60046721f.png"></p>
<h2 is-upgraded>音声メッセージを扱う</h2>
<p>マイクから音声を投稿してみてください。音声メッセージが返ってきます。</p>
<ul>
<li><a href="https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L131" target="_blank">https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L131</a></li>
</ul>
<p class="image-container"><img style="width: 312.70px" src="img/cb4fa05434519c73.png"></p>
<aside class="special"><p><strong>Note:</strong> 音声も画像の時と同じで、 [投稿された音声をAzure Storageに格納] &gt; [Azure Storageに格納された音声のURLを取得] &gt; [音声メッセージとしてユーザに返す] という流れで実施しています。</p>
</aside>
<h2 is-upgraded>Flex Messageを扱う</h2>
<p>リッチメニューの左下をタップして、「flex」というテキストメッセージを投稿します。するとちょっとリッチなUIが返ってくると思います。これがFlex Messageです。<a href="https://developers.line.biz/flex-simulator/" target="_blank">Flex Message Simulator</a> が用意されており、レイアウトを簡単にカスタマイズすることができます。（詳細は<a href="https://developers.line.biz/ja/docs/messaging-api/using-flex-message-simulator/" target="_blank">コチラ</a>を参照ください。）</p>
<ul>
<li><a href="https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L76" target="_blank">https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L76</a></li>
</ul>
<p class="image-container"><img style="width: 305.00px" src="img/81d3c8209c747f44.gif"></p>
<h2 is-upgraded>Quick Replyを扱う</h2>
<p>クイックリプライを使うとユーザは簡単に返信を行うことができます。</p>
<ul>
<li><a href="https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L83" target="_blank">https://github.com/mochan-tk/Handson-LINE-Bot-Azure-template/blob/master/deployPrj01/LineHttpTriggeredFunction/index.js#L83</a></li>
</ul>
<p class="image-container"><img style="width: 305.00px" src="img/c9c578aa154790e8.gif"></p>
<aside class="special"><p><strong>Note:</strong> 今回クイックリプライには「Yes」、「No」、「camera」の選択肢を用意しました。「Yes」とするとpostbackというメッセージの送信を行うようにしています。</p>
<p>詳しくは下記を参照ください。</p>
<p>https://developers.line.biz/ja/docs/messaging-api/actions/#postback-action</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="リッチメニュー応用" duration="20">
        <h2 is-upgraded>Messaging APIでリッチメニューを作成する</h2>
<p>リッチメニューはMessaging APIで作成することもでき、自由なレイアウトの画像を使ったりユーザーごとに異なるリッチメニューを適用させたりできます。</p>
<h2 is-upgraded>リッチメニューで会員証を実装する</h2>
<p>まずはリッチメニュー応用のコードの取得とデプロイを実施してください。</p>
<pre><code>## リッチメニュー応用のブランチに切り替え
git checkout advanced-richmenu

cd /workspace/Handson-LINE-Bot-Azure-template/deployPrj01/

## 下記実行で、作成したAzure Functionsの名前を取得
az deployment group show \
 -g ${group_name} \
 -n deployPrj01 \
 --query properties.outputs.functionAppName.value

## &lt;functionAppName&gt;の部分を、上記で取得したAzure Functionsの名前に置き換える
func azure functionapp publish &lt;functionAppName&gt; --build remote
</code></pre>
<p>デプロイが完了したら、Messaging APIによるリッチメニュー切り替えを活用した会員登録フローを体験してみましょう。テキストメッセージで「会員登録」と送信してみてください。</p>
<p>すると「会員登録を行います。よろしいですか？」というメッセージが、「Yes」「No」のクイックリプライとともに返ってくると思います。</p>
<p class="image-container"><img style="width: 314.50px" src="img/220de43aafdcc2c3.jpeg"></p>
<p>「Yes」をタップすると、続けて「会員名を送信してください。」と送られてきます。</p>
<p>任意の名前をテキストで入力し送信すると、会員登録が完了し、会員専用の新たなリッチメニューが設定されます。</p>
<p class="image-container"><img style="width: 391.50px" src="img/827f81e7fcc62ad4.jpeg"></p>
<p>設定されたリッチメニューは、会員証です。</p>
<p>このQRコードを読み込むと、さきほど設定した会員名が確認できます。</p>
<p class="image-container"><img style="width: 388.90px" src="img/96a35b2b7526b7cc.jpeg"></p>
<aside class="special"><p><strong>Note:</strong> ここまでのBotとのやりとりは1往復で完結するものでしたが、会員登録フローはそうではありません。ユーザーとBotの間でメッセージを何度かやりとりしてフローが完結する動きのため、Botサーバー側では会員登録フローがどこまで進んでいるかを覚えておく必要があります。</p>
<p>今回はAzure Functionsの拡張機能「Durable Functions」を使い、複数の関数の組み合わせでこれを実現しています。ぜひコードも確認してみてください。</p>
<p>またリッチメニューの作成・切替も、さらに別の関数で動いています。</p>
<p>会員名のデータはCosmos DBに格納されますが、そのデータが登録・変更されたタイミングで呼び出される関数（Change Feed・Cosmos DBトリガー）が、画像の生成やリッチメニュー作成・切替を担当しています。</p>
<p>Durable FunctionsやChange Feedの仕組み・LINEとの組み合わせ方については以下の動画でも解説していますので、参考にしてみてください。</p>
<p><a href="https://www.youtube.com/watch?v=901joW1MCbU" target="_blank">（YouTube）あなたならどう使う？最新Azureレシピ for LINE Platform / 平林 拓将 | REV UP2020</a></p>
</aside>
<h2 is-upgraded>退会処理</h2>
<p>テキストメッセージで「退会」と送信すると、退会処理が実行され会員証のリッチメニューが解除されるようになってます。</p>
<p>元のリッチメニューを使いたいときやもう一度会員登録処理を試してみたいときは、「退会」と送ってみてください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="リソースの削除" duration="5">
        <p>課金が気になる方は、下記のコマンドを実行してリソースグループごと作成したAzureのリソースを削除してください。</p>
<pre><code>az group delete --name ${group_name}</code></pre>
<aside class="warning"><p><strong>注意:</strong> ２つ目のハンズオンで、ここで扱った内容を使うのでリソースの削除は２つ目のハンズオン終了後でお願いします！</p>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://mochan-tk.github.io/claat-public/native-shim.js"></script>
  <script src="https://mochan-tk.github.io/claat-public/custom-elements.min.js"></script>
  <script src="https://mochan-tk.github.io/claat-public/prettify.js"></script>
  <script src="https://mochan-tk.github.io/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
